------- Consultation -------



select * from CLUBS;
//////////////
select * from EQUIPES;
//////////////
select * from JOUEURS;
//////////////

select R.DATE_DE_RENCONTRE,E1.NOM_EQUIPE as EQUIPE_ACCUEILLANTE,R.SCORE_EQUIPE_ACCUEILLANTE,E2.NOM_EQUIPE as EQUIPE_RECUS,R.SCORE_EQUIPE_RECUE
    from RENCONTRES R, EQUIPES E1, EQUIPES E2
    where E1.NUMERO_EQUIPE  = R.NUMERO_EQUIPE_ACCUEILLANTE and E2.NUMERO_EQUIPE  = R.NUMERO_EQUIPE_RECUE; 

//////////////

select R.DATE_DE_RENCONTRE, J.NOM_JOUEUR as NOM, J.PRENOM_JOUEUR as PRENOM
    from JOUEURS J, PARTICIPER P,RENCONTRES R 
    where R.NUMERO_DE_RENCONTRE = P.NUMERO_DE_RENCONTRE and P.NUMERO_DE_LICENCE = J.NUMERO_DE_LICENCE;

////////////// FEUILLE DU MATCH

create view T1 (NUMERO_DE_RENCONTRE,DATE_DE_RENCONTRE,EQUIPE_ACCUEILLANTE,NOM,PRENOM,BUTS,FAUTES,SCORE)
as select  R.NUMERO_DE_RENCONTRE,
        R.DATE_DE_RENCONTRE,
        E.NOM_EQUIPE,
        J.NOM_JOUEUR,
        J.PRENOM_JOUEUR,
        P.NOMBRE_POINTS_MARQUES,
        P.NOMBRE_FAUTES_COMMISES,
        R.SCORE_EQUIPE_ACCUEILLANTE
        
        from RENCONTRES R, EQUIPES E, PARTICIPER P, JOUEURS J
        where R.NUMERO_EQUIPE_ACCUEILLANTE = E.NUMERO_EQUIPE
            and R.NUMERO_DE_RENCONTRE = P.NUMERO_DE_RENCONTRE
            and P.NUMERO_DE_LICENCE = J.NUMERO_DE_LICENCE
        ;
        

create view T2 (NUMERO_DE_RENCONTRE,DATE_DE_RENCONTRE,EQUIPE_RECUS,NOM,PRENOM,BUTS,FAUTES,SCORE)
as select  R.NUMERO_DE_RENCONTRE,
        R.DATE_DE_RENCONTRE,
        E.NOM_EQUIPE,
        J.NOM_JOUEUR,
        J.PRENOM_JOUEUR,
        P.NOMBRE_POINTS_MARQUES,
        P.NOMBRE_FAUTES_COMMISES,
        R.SCORE_EQUIPE_RECUE
        
        from RENCONTRES R, EQUIPES E, PARTICIPER P, JOUEURS J
        where R.NUMERO_EQUIPE_RECUE = E.NUMERO_EQUIPE
            and R.NUMERO_DE_RENCONTRE = P.NUMERO_DE_RENCONTRE
            and P.NUMERO_DE_LICENCE = J.NUMERO_DE_LICENCE
        ;

select T1.NUMERO_DE_RENCONTRE,
    T1.DATE_DE_RENCONTRE,
    T1.EQUIPE_ACCUEILLANTE,
    T1.NOM,
    T1.PRENOM,
    T1.BUTS,
    T1.FAUTES,
    T1.SCORE,
    T2.EQUIPE_RECUS,
    T2.NOM,
    T2.PRENOM,
    T2.BUTS,
    T2.FAUTES,
    T2.SCORE
    from T1 inner join T2 using (NUMERO_DE_RENCONTRE) order by NUMERO_DE_RENCONTRE;
//////////////



% nbre matches gagnes par equipe
select E.NUMERO_EQUIPE , E.NOM_EQUIPE, count(*) as MATCHS_GAGNE 
    from EQUIPES E, RENCONTRES R 
    where (E.NUMERO_EQUIPE = R.NUMERO_EQUIPE_ACCUEILLANTE and R.SCORE_EQUIPE_ACCUEILLANTE > R.SCORE_EQUIPE_RECUE) 
        or (E.NUMERO_EQUIPE = R.NUMERO_EQUIPE_RECUE and R.SCORE_EQUIPE_RECUE > R.SCORE_EQUIPE_ACCUEILLANTE)
        group by 1,2; 




% nbre matches perdues par equipe
select E.NUMERO_EQUIPE , E.NOM_EQUIPE, count(*) as MATCHS_PERDUES 
    from EQUIPES E, RENCONTRES R 
    where (E.NUMERO_EQUIPE = R.NUMERO_EQUIPE_ACCUEILLANTE and R.SCORE_EQUIPE_ACCUEILLANTE < R.SCORE_EQUIPE_RECUE) 
        or (E.NUMERO_EQUIPE = R.NUMERO_EQUIPE_RECUE and R.SCORE_EQUIPE_RECUE < R.SCORE_EQUIPE_ACCUEILLANTE)
        group by 1;

%nbre de matches nuls par equipe
select E.NUMERO_EQUIPE , E.NOM_EQUIPE, count(*) as MATCHS_NULS 
    from EQUIPES E, RENCONTRES R 
    where (E.NUMERO_EQUIPE = R.NUMERO_EQUIPE_ACCUEILLANTE and R.SCORE_EQUIPE_ACCUEILLANTE = R.SCORE_EQUIPE_RECUE)
    group by 1;

% nbre matches gagnes par club
select C.NUMERO_CLUB , C.NOM_CLUB, count(*) as MATCHS_GAGNE 
    from CLUBS C, EQUIPES E, RENCONTRES R 
    where E.NUMERO_CLUB = C.NUMERO_CLUB
        and ( (E.NUMERO_EQUIPE = R.NUMERO_EQUIPE_ACCUEILLANTE and R.SCORE_EQUIPE_ACCUEILLANTE > R.SCORE_EQUIPE_RECUE) 
        or (E.NUMERO_EQUIPE = R.NUMERO_EQUIPE_RECUE and R.SCORE_EQUIPE_RECUE > R.SCORE_EQUIPE_ACCUEILLANTE))
        group by 1; 


% nbre matches perdues par club
select C.NUMERO_CLUB , C.NOM_CLUB, count(*) as MATCHS_PERDUES 
    from CLUBS C, EQUIPES E, RENCONTRES R 
    where E.NUMERO_CLUB = C.NUMERO_CLUB
        and ( (E.NUMERO_EQUIPE = R.NUMERO_EQUIPE_ACCUEILLANTE and R.SCORE_EQUIPE_ACCUEILLANTE < R.SCORE_EQUIPE_RECUE) 
        or (E.NUMERO_EQUIPE = R.NUMERO_EQUIPE_RECUE and R.SCORE_EQUIPE_RECUE < R.SCORE_EQUIPE_ACCUEILLANTE) )
        group by 1; 



%nbre de matches nuls par club
select C.NUMERO_CLUB , C.NOM_CLUB, count(*) as MATCHS_NULS 
    from CLUBS C, EQUIPES E, RENCONTRES R 
    where E.NUMERO_CLUB = C.NUMERO_CLUB
        and ( (E.NUMERO_EQUIPE = R.NUMERO_EQUIPE_ACCUEILLANTE and R.SCORE_EQUIPE_ACCUEILLANTE = R.SCORE_EQUIPE_RECUE) )
        group by 1; 

-------- Statistques --------
////////
%moyenne des points marqués PAR RENCONTRE à une date donnée
select DATE_DE_RENCONTRE, NUMERO_DE_RENCONTRE, (R.SCORE_EQUIPE_ACCUEILLANTE + R.SCORE_EQUIPE_RECUE) as RR, AVG( R.SCORE_EQUIPE_ACCUEILLANTE + R.SCORE_EQUIPE_RECUE ) as MOYENNE_POINTS
    from RENCONTRES R
    group by 1
    ;


%moyenne des points marqués depuis le début de la saison
select S.DATE_DE_DEBUT as DEBUT_DE_SAISON , AVG( (R.SCORE_EQUIPE_ACCUEILLANTE + R.SCORE_EQUIPE_RECUE)/2 )
    from RENCONTRES R, PARTICIPER P, JOUEURS J, SAISONS_JOUEES SJ, SAISONS S
    where R.NUMERO_DE_RENCONTRE = P.NUMERO_DE_RENCONTRE
        and P.NUMERO_DE_LICENCE = J.NUMERO_DE_LICENCE
        and J.NUMERO_DE_LICENCE = SJ.NUMERO_DE_LICENCE
        and SJ.NUMERO_SAISON = S.NUMERO_SAISON
	and R.DATE_DE_RENCONTRE > S.DATE_DE_DEBUT
    group by 1;

////////

select R.DATE_DE_RENCONTRE,J.NUMERO_DE_LICENCE,J.NOM_JOUEUR,J.PRENOM_JOUEUR,P.NOMBRE_POINTS_MARQUES,P.NOMBRE_FAUTES_COMMISES
    from RENCONTRES R, PARTICIPER P, JOUEURS J where R.NUMERO_DE_RENCONTRE = P.NUMERO_DE_RENCONTRE and P.NUMERO_DE_LICENCE = J.NUMERO_DE_LICENCE
    order by 5 DESC,6 ASC;

//////// classement equipe par saison
%les RENCONTRES d'une équipe avec resultat


create or replace view TAB (SAISON,NUM_EQUIPE,RENCONTRE,DATE,W,L,N)
as select S.NUMERO_SAISON SAISON,
    R.NUMERO_EQUIPE_ACCUEILLANTE as NUM_EQUIPE,
    R.NUMERO_DE_RENCONTRE as RENCONTRE, 
    R.DATE_DE_RENCONTRE as DATE,
    count(case when R.SCORE_EQUIPE_ACCUEILLANTE>R.SCORE_EQUIPE_RECUE then 1 else null end) as W,
    count(case when R.SCORE_EQUIPE_ACCUEILLANTE<R.SCORE_EQUIPE_RECUE then 1 else null end) as L,
    count(case when R.SCORE_EQUIPE_ACCUEILLANTE=R.SCORE_EQUIPE_RECUE then 1 else null end) as N
    from RENCONTRES R,SAISONS S
    where DATEDIFF(R.DATE_DE_RENCONTRE,S.DATE_DE_DEBUT) < 365 and DATEDIFF(R.DATE_DE_RENCONTRE,S.DATE_DE_DEBUT)>0
    group by 1,2,3,4

union

select S.NUMERO_SAISON SAISON,
    R.NUMERO_EQUIPE_RECUE as NUM_EQUIPE,
    R.NUMERO_DE_RENCONTRE as RENCONTRE, 
    R.DATE_DE_RENCONTRE as DATE,
    count(case when R.SCORE_EQUIPE_ACCUEILLANTE<R.SCORE_EQUIPE_RECUE then 1 else null end) as W,
    count(case when R.SCORE_EQUIPE_ACCUEILLANTE>R.SCORE_EQUIPE_RECUE then 1 else null end) as L,
    count(case when R.SCORE_EQUIPE_ACCUEILLANTE=R.SCORE_EQUIPE_RECUE then 1 else null end) as N
    from RENCONTRES R, SAISONS S
    where DATEDIFF(R.DATE_DE_RENCONTRE,S.DATE_DE_DEBUT) < 365 and DATEDIFF(R.DATE_DE_RENCONTRE,S.DATE_DE_DEBUT)>0
    group by 1,2,3,4
;

% pour un classement dans une saison donnée

select TAB.NUM_EQUIPE,E.NOM_EQUIPE,SUM(TAB.W) as W,SUM(TAB.L) as L,SUM(TAB.N) as N 
    from TAB , EQUIPES E where E.NUMERO_EQUIPE = TAB.NUM_EQUIPE and TAB.SAISON = 2 group by 1,2 
    order by 3 DESC, 4 ASC ,5 DESC;

    


------------MISE À JOUR------------
//////////// AJOUT JOUEUR 

insert into JOUEURS values (13732  ,   'HAMID'    ,   'TIRACHRACH'   ,   '1990-08-07'    ,    'HAMID3@GMAIL.COM' ,   0630797500);
commit;
/////////// SUPRESSION D'UN JOUEUR

delete from JOUEURS where NOM_JOUEUR = 'HAMID';
commit;
/////////// MODIFICATION

update JOUEURS set TELEPHONE_JOUEUR = 630071080 where NUMERO_DE_LICENCE = 10424;
commit;
update CLUBS set NOM_CLUB = 'INTER MILAN' where NOM_CLUB = 'BARCELONA';
commit;
update RENCONTRES set SCORE_EQUIPE_ACCUEILLANTE = 36 where NUMERO_DE_RENCONTRE = 1;
commit;